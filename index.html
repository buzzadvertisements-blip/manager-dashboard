<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        :root{--primary:#2563eb;--primary-dark:#1e40af;--bg:#0f172a;--card:#1e293b;--input:#334155;--text:#f1f5f9;--muted:#94a3b8;--border:#334155;--accent:#3b82f6;--success:#10b981;--danger:#ef4444;}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
        .sidebar{position:fixed;left:0;top:0;bottom:0;width:250px;background:var(--card);border-right:1px solid var(--border);display:flex;flex-direction:column;z-index:100;overflow-y:auto;}
        .sidebar-logo{padding:1.5rem;border-bottom:1px solid var(--border);}
        .sidebar-logo h1{font-size:1.1rem;font-weight:700;background:linear-gradient(135deg,var(--text),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .sidebar-logo p{font-size:0.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-top:0.2rem;}
        .sidebar-section{padding:0.75rem 0;border-bottom:1px solid var(--border);}
        .sidebar-title{padding:0.4rem 1.25rem;font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--muted);}
        .nav-item{display:flex;align-items:center;gap:0.6rem;padding:0.55rem 1.25rem;cursor:pointer;transition:all 0.2s;font-size:0.9rem;color:var(--muted);position:relative;}
        .nav-item:hover{background:rgba(59,130,246,0.08);color:var(--text);}
        .nav-item.active{background:rgba(59,130,246,0.15);color:var(--accent);font-weight:600;}
        .nav-item.active::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);border-radius:0 2px 2px 0;}
        .refresh-btn{margin:1rem 1.25rem;padding:0.6rem 1rem;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:0.5rem;color:var(--success);cursor:pointer;font-size:0.85rem;text-align:center;font-weight:600;font-family:'DM Sans',sans-serif;}
        .refresh-btn:hover{background:rgba(16,185,129,0.2);}
        .add-emp-btn{margin:0 1.25rem 1rem;padding:0.6rem 1rem;background:rgba(59,130,246,0.1);border:1px dashed var(--accent);border-radius:0.5rem;color:var(--accent);cursor:pointer;font-size:0.85rem;text-align:center;font-weight:600;}
        .add-emp-btn:hover{background:rgba(59,130,246,0.2);}
        .main{margin-left:250px;padding:2rem;min-height:100vh;}
        .page{display:none;} .page.active{display:block;}
        .page-header{margin-bottom:2rem;padding-bottom:1.5rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;}
        .page-header h2{font-size:1.8rem;font-weight:700;background:linear-gradient(135deg,var(--text),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
        .status-badge{display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:var(--card);border:1px solid var(--border);border-radius:2rem;font-size:0.78rem;font-family:'JetBrains Mono',monospace;}
        .dot{width:7px;height:7px;border-radius:50%;background:var(--success);animation:pulse 2s infinite;}
        @keyframes pulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
        .card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;}
        .card h3{font-size:1.1rem;font-weight:600;margin-bottom:1.25rem;}
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(440px,1fr));gap:1.5rem;margin-bottom:2rem;}
        .chart-card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1.5rem;transition:all 0.3s;}
        .chart-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.25);}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;}
        .chart-title{font-size:1.05rem;font-weight:600;}
        .chart-value{font-size:1.35rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent);}
        .chart-canvas{position:relative;height:240px;}
        .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem;margin-bottom:2rem;}
        .summary-card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1.25rem;text-align:center;}
        .s-name{font-size:0.8rem;color:var(--muted);margin-bottom:0.4rem;}
        .s-val{font-size:1.5rem;font-weight:700;font-family:'JetBrains Mono',monospace;color:var(--accent);}
        .s-graph{font-size:0.72rem;color:var(--muted);margin-top:0.2rem;}
        .comp-card{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:1.5rem;margin-bottom:1.5rem;}
        .comp-canvas{position:relative;height:280px;}
        .data-table{background:var(--card);border:1px solid var(--border);border-radius:1rem;overflow:hidden;margin-bottom:2rem;}
        .table-header{padding:1rem 1.5rem;border-bottom:1px solid var(--border);font-weight:600;}
        table{width:100%;border-collapse:collapse;}
        thead{background:var(--input);}
        th{padding:0.7rem 1rem;text-align:left;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;color:var(--muted);}
        td{padding:0.7rem 1rem;border-top:1px solid var(--border);font-family:'JetBrains Mono',monospace;font-size:0.82rem;}
        tbody tr:hover{background:rgba(59,130,246,0.04);}
        /* SETTINGS */
        .s-emp-card{background:var(--bg);border:1px solid var(--border);border-radius:0.75rem;padding:1.25rem;margin-bottom:1rem;}
        .s-emp-header{display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;flex-wrap:wrap;}
        .name-input{flex:1;padding:0.55rem 0.8rem;background:var(--input);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.9rem;font-family:'DM Sans',sans-serif;min-width:160px;}
        .name-input:focus{outline:none;border-color:var(--accent);}
        .graph-tags{display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:0.75rem;min-height:32px;}
        .g-tag{display:inline-flex;align-items:center;gap:0.35rem;padding:0.3rem 0.7rem;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:2rem;font-size:0.82rem;color:var(--accent);}
        .g-del{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:0.82rem;padding:0;line-height:1;}
        .g-del:hover{color:var(--danger);}
        .add-g-row{display:flex;gap:0.5rem;}
        .add-g-inp{flex:1;padding:0.5rem 0.75rem;background:var(--input);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.85rem;font-family:'DM Sans',sans-serif;}
        .add-g-inp:focus{outline:none;border-color:var(--accent);}
        /* BUTTONS */
        button{padding:0.55rem 1.1rem;border:none;border-radius:0.5rem;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;font-family:'DM Sans',sans-serif;}
        .btn-p{background:var(--primary);color:white;} .btn-p:hover{background:var(--primary-dark);}
        .btn-a{background:var(--accent);color:white;} .btn-a:hover{background:var(--primary-dark);}
        .btn-s{background:var(--success);color:white;} .btn-s:hover{background:#059669;}
        .btn-d{background:transparent;color:var(--danger);border:1px solid var(--danger);} .btn-d:hover{background:var(--danger);color:white;}
        .btn-g{background:var(--input);color:var(--text);border:1px solid var(--border);}
        .sm{padding:0.35rem 0.75rem;font-size:0.78rem;}
        /* LINKS */
        .link-row{display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;flex-wrap:wrap;}
        .link-name{min-width:120px;font-weight:600;}
        .link-url{flex:1;padding:0.55rem 0.8rem;background:var(--input);border:1px solid var(--border);border-radius:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;}
        .copy-btn{padding:0.5rem 0.9rem;background:var(--accent);color:white;border:none;border-radius:0.5rem;cursor:pointer;font-size:0.8rem;font-weight:600;white-space:nowrap;}
        .copy-btn:hover{background:var(--primary-dark);}
        /* MODAL */
        .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:center;justify-content:center;}
        .overlay.open{display:flex;}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:1rem;padding:2rem;width:100%;max-width:400px;margin:1rem;}
        .modal h3{font-size:1.15rem;margin-bottom:1.25rem;}
        .fg{display:flex;flex-direction:column;gap:0.4rem;margin-bottom:1rem;}
        .fg label{font-size:0.75rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.05em;}
        .fg input{padding:0.65rem 0.85rem;background:var(--input);border:1px solid var(--border);border-radius:0.5rem;color:var(--text);font-size:0.9rem;font-family:'DM Sans',sans-serif;}
        .fg input:focus{outline:none;border-color:var(--accent);}
        .btn-row{display:flex;gap:0.75rem;margin-top:0.5rem;}
        /* TOAST */
        .toast{position:fixed;bottom:2rem;right:2rem;padding:1rem 1.5rem;border-radius:0.75rem;font-weight:600;font-size:0.9rem;z-index:999;display:none;}
        .toast.ok{background:var(--success);color:white;} .toast.err{background:var(--danger);color:white;}
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-logo">
        <h1>üìä Manager Dashboard</h1>
        <p>Employee Stats Overview</p>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-title">General</div>
        <div class="nav-item active" onclick="showPage('overview')" id="nav-overview">üè† Overview</div>
        <div class="nav-item" onclick="showPage('comparison')" id="nav-comparison">‚öñÔ∏è Comparison</div>
        <div class="nav-item" onclick="showPage('links')" id="nav-links">üîó Employee Links</div>
        <div class="nav-item" onclick="showPage('settings')" id="nav-settings">‚öôÔ∏è Settings</div>
    </div>
    <div class="sidebar-section">
        <div class="sidebar-title">Employees</div>
        <div id="empNav"></div>
        <div class="add-emp-btn" onclick="openModal()">+ Add Employee</div>
    </div>
    <button class="refresh-btn" onclick="refreshAll()">üîÑ Refresh Data</button>
    <div style="padding:0.5rem 1.25rem 1rem;font-size:0.72rem;color:var(--muted);font-family:'JetBrains Mono',monospace;" id="lastRefresh"></div>
</div>

<div class="main">
    <div class="page active" id="page-overview">
        <div class="page-header"><h2>Overview</h2><div class="status-badge"><span class="dot"></span> Live ¬∑ Supabase</div></div>
        <div class="summary-grid" id="summaryGrid"></div>
        <div class="charts-grid" id="overviewCharts"></div>
    </div>

    <div class="page" id="page-comparison">
        <div class="page-header"><h2>‚öñÔ∏è Comparison</h2></div>
        <div id="compContent"></div>
    </div>

    <div class="page" id="page-links">
        <div class="page-header"><h2>üîó Employee Links</h2></div>
        <p style="color:var(--muted);margin-bottom:1.5rem;">Send these links to your employees. Each link opens their personal report page.</p>
        <div class="card" id="linksContent"></div>
    </div>

    <div class="page" id="page-settings">
        <div class="page-header"><h2>‚öôÔ∏è Settings</h2></div>
        <div class="card">
            <h3>üë• Employees & Graphs</h3>
            <p style="color:var(--muted);font-size:0.88rem;margin-bottom:1.5rem;">Edit names, add or remove graphs for each employee.</p>
            <div id="settingsContent"></div>
        </div>
    </div>

    <div id="empPages"></div>
</div>

<!-- ADD EMPLOYEE MODAL -->
<div class="overlay" id="modal">
    <div class="modal">
        <h3>‚ûï Add New Employee</h3>
        <div class="fg"><label>Full Name</label><input id="newEmpName" placeholder="e.g. John Smith"/></div>
        <div class="btn-row">
            <button class="btn-p" onclick="addEmployee()">Add Employee</button>
            <button class="btn-g" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SB_URL = 'https://fuvnwjskwjtvpwtbdzey.supabase.co';
const SB_KEY = 'sb_publishable_8w77NMR3vcQXnJ6YpbN6Fw_6QgiI6Sl';
const EMP_PAGE = 'https://buzzadvertisements-blip.github.io/employee-fill/';
const COLORS = ['#3b82f6','#22c55e','#f59e0b','#ec4899','#8b5cf6','#06b6d4','#f97316'];

let config = [];
let allData = {};

async function sb(method, table, body, qs='') {
    const r = await fetch(`${SB_URL}/rest/v1/${table}${qs}`, {
        method,
        headers:{'apikey':SB_KEY,'Authorization':`Bearer ${SB_KEY}`,'Content-Type':'application/json','Prefer':method==='POST'?'return=representation':method==='PATCH'?'return=representation':''},
        body: body ? JSON.stringify(body) : undefined
    });
    const t = await r.text();
    return t ? JSON.parse(t) : null;
}

async function loadConfig() {
    const rows = await sb('GET','employee_config',null,'?order=created_at.asc');
    config = (rows||[]).map(r=>({...r, graphs: typeof r.graphs==='string' ? JSON.parse(r.graphs) : (r.graphs||[])}));
}

async function loadData() {
    const rows = await sb('GET','employee_data',null,'?order=year.asc,week.asc');
    allData = {};
    config.forEach(e => allData[e.employee_id]=[]);
    (rows||[]).forEach(r=>{ if(allData[r.employee_id]) allData[r.employee_id].push(r); });
}

function getWeekDates(year, week) {
    const jan1 = new Date(year,0,1), dow = jan1.getDay()||7;
    const mon = new Date(jan1); mon.setDate(jan1.getDate()+(week-1)*7-dow+1);
    const sun = new Date(mon); sun.setDate(mon.getDate()+6);
    const f = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    return `${f(mon)} ‚Äì ${f(sun)}`;
}

function showPage(id) {
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.getElementById('page-'+id)?.classList.add('active');
    document.getElementById('nav-'+id)?.classList.add('active');
}

function toast(msg, ok=true) {
    const t = document.getElementById('toast');
    t.textContent=msg; t.className=`toast ${ok?'ok':'err'}`; t.style.display='block';
    setTimeout(()=>t.style.display='none',3000);
}

function mkChart(cid, labels, datasets) {
    const el = document.getElementById(cid); if(!el) return;
    return new Chart(el.getContext('2d'),{
        type:'line', data:{labels,datasets},
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{display:datasets.length>1,labels:{color:'#94a3b8',boxWidth:12}}},
            scales:{y:{beginAtZero:true,grid:{color:'rgba(148,163,184,0.1)'},ticks:{color:'#94a3b8'}},
                    x:{grid:{color:'rgba(148,163,184,0.1)'},ticks:{color:'#94a3b8',maxRotation:45}}}}
    });
}

// NAV
function renderNav() {
    const c = document.getElementById('empNav'); c.innerHTML='';
    config.forEach(emp=>{
        const d = document.createElement('div');
        d.className='nav-item'; d.id='nav-'+emp.employee_id;
        d.textContent='üë§ '+emp.employee_name;
        d.onclick=()=>showPage(emp.employee_id);
        c.appendChild(d);
    });
}

// OVERVIEW
function renderOverview() {
    const sg = document.getElementById('summaryGrid'), oc = document.getElementById('overviewCharts');
    sg.innerHTML=''; oc.innerHTML='';
    config.forEach((emp,i)=>{
        const data = allData[emp.employee_id]||[];
        emp.graphs.forEach(g=>{
            const entries = data.filter(d=>d.graph_name===g);
            const latest = entries.length ? entries[entries.length-1].value : 0;
            sg.innerHTML += `<div class="summary-card"><div class="s-name">${emp.employee_name}</div><div class="s-val">${Number(latest).toLocaleString()}</div><div class="s-graph">${g}</div></div>`;
            const last12 = entries.slice(-12), cid=`ov_${emp.employee_id}_${g.replace(/\W/g,'_')}`, col=COLORS[i%COLORS.length];
            oc.innerHTML += `<div class="chart-card"><div class="chart-header"><span class="chart-title">${emp.employee_name} ‚Äî ${g}</span><span class="chart-value">${Number(latest).toLocaleString()}</span></div><div class="chart-canvas"><canvas id="${cid}"></canvas></div></div>`;
            setTimeout(()=>mkChart(cid, last12.map(d=>`W${String(d.week).padStart(2,'0')} '${String(d.year).slice(2)}`), [{data:last12.map(d=>d.value),borderColor:col,backgroundColor:col+'22',borderWidth:2.5,tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:col,pointBorderColor:'#1e293b',pointBorderWidth:2}]),80);
        });
    });
    if(!config.length) oc.innerHTML='<p style="color:var(--muted);grid-column:1/-1;text-align:center;padding:3rem;">No employees. Add one in Settings!</p>';
}

// COMPARISON
function renderComparison() {
    const c = document.getElementById('compContent'); c.innerHTML='';
    const graphs = [...new Set(config.flatMap(e=>e.graphs))];
    graphs.forEach(g=>{
        const weeks = [...new Set(Object.values(allData).flat().filter(d=>d.graph_name===g).map(d=>`${d.year}-W${String(d.week).padStart(2,'0')}`))].sort().slice(-12);
        const cid = `comp_${g.replace(/\W/g,'_')}`;
        c.innerHTML += `<div class="comp-card"><h3>üìä ${g}</h3><div class="comp-canvas"><canvas id="${cid}"></canvas></div></div>`;
        const ds = config.map((emp,i)=>({
            label:emp.employee_name,
            data:weeks.map(wk=>{const[y,w]=wk.split('-W').map(Number);const e=(allData[emp.employee_id]||[]).find(d=>d.graph_name===g&&d.year===y&&d.week===w);return e?e.value:null;}),
            borderColor:COLORS[i%COLORS.length],backgroundColor:'transparent',borderWidth:2.5,tension:0.4,pointRadius:4,pointBackgroundColor:COLORS[i%COLORS.length],pointBorderColor:'#1e293b',pointBorderWidth:2
        }));
        setTimeout(()=>mkChart(cid,weeks.map(w=>w.replace('-W',' W')),ds),80);
    });
    if(!graphs.length) c.innerHTML='<p style="color:var(--muted);text-align:center;padding:3rem;">No data yet.</p>';
}

// LINKS
function renderLinks() {
    const c = document.getElementById('linksContent'); c.innerHTML='';
    config.forEach(emp=>{
        const url=`${EMP_PAGE}?emp=${emp.employee_id}`;
        c.innerHTML+=`<div class="link-row"><span class="link-name">üë§ ${emp.employee_name}</span><div class="link-url">${url}</div><button class="copy-btn" onclick="copyLink('${url}',this)">üìã Copy</button></div>`;
    });
    if(!config.length) c.innerHTML='<p style="color:var(--muted)">No employees yet.</p>';
}
function copyLink(url,btn){navigator.clipboard.writeText(url);btn.textContent='‚úÖ Copied!';setTimeout(()=>btn.textContent='üìã Copy',2000);}

// SETTINGS
function renderSettings() {
    const c = document.getElementById('settingsContent'); c.innerHTML='';
    config.forEach(emp=>{
        const tags = emp.graphs.map(g=>`<div class="g-tag">${g}<button class="g-del" onclick="removeGraph('${emp.employee_id}','${g}')">‚úï</button></div>`).join('') || '<span style="color:var(--muted);font-size:0.82rem;">No graphs yet</span>';
        c.innerHTML+=`
        <div class="s-emp-card">
            <div class="s-emp-header">
                <span>üë§</span>
                <input class="name-input" id="nm_${emp.employee_id}" value="${emp.employee_name}" placeholder="Name"/>
                <button class="btn-p sm" onclick="saveName('${emp.employee_id}')">Save Name</button>
            </div>
            <div style="font-size:0.72rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Graphs</div>
            <div class="graph-tags" id="tags_${emp.employee_id}">${tags}</div>
            <div class="add-g-row">
                <input class="add-g-inp" id="ng_${emp.employee_id}" placeholder="New graph name..." onkeydown="if(event.key==='Enter'){addGraph('${emp.employee_id}');}"/>
                <button class="btn-a sm" onclick="addGraph('${emp.employee_id}')">+ Add</button>
            </div>
        </div>`;
    });
}

async function saveName(id) {
    const name = document.getElementById(`nm_${id}`).value.trim();
    if(!name) return;
    const emp = config.find(e=>e.employee_id===id);
    try { await sb('PATCH','employee_config',{employee_name:name},`?employee_id=eq.${id}`); await loadConfig(); renderAll(); toast('‚úÖ Name updated!'); } catch(e){ toast('‚ùå Error',false); }
}

async function addGraph(id) {
    const inp = document.getElementById(`ng_${id}`), name=inp.value.trim(); if(!name) return;
    const emp = config.find(e=>e.employee_id===id);
    if(emp.graphs.includes(name)){toast('Graph already exists!',false);return;}
    try { await sb('PATCH','employee_config',{graphs:JSON.stringify([...emp.graphs,name])},`?employee_id=eq.${id}`); inp.value=''; await loadConfig(); renderAll(); toast('‚úÖ Graph added!'); } catch(e){ toast('‚ùå Error',false); }
}

async function removeGraph(id, g) {
    if(!confirm(`Remove graph "${g}"?`)) return;
    const emp = config.find(e=>e.employee_id===id);
    try { await sb('PATCH','employee_config',{graphs:JSON.stringify(emp.graphs.filter(x=>x!==g))},`?employee_id=eq.${id}`); await loadConfig(); renderAll(); toast('‚úÖ Removed!'); } catch(e){ toast('‚ùå Error',false); }
}

// EMPLOYEE PAGES
function renderEmpPages() {
    const c = document.getElementById('empPages'); c.innerHTML='';
    config.forEach((emp,i)=>{
        const data=allData[emp.employee_id]||[], col=COLORS[i%COLORS.length];
        const weeks=[...new Set(data.map(d=>`${d.year}-${d.week}`))].sort().reverse();
        const chartsHtml = emp.graphs.map(g=>{
            const e=data.filter(d=>d.graph_name===g).slice(-12), lat=e.length?e[e.length-1].value:0, cid=`ep_${emp.employee_id}_${g.replace(/\W/g,'_')}`;
            return `<div class="chart-card"><div class="chart-header"><span class="chart-title">${g}</span><span class="chart-value">${Number(lat).toLocaleString()}</span></div><div class="chart-canvas"><canvas id="${cid}"></canvas></div></div>`;
        }).join('') || '<p style="color:var(--muted)">No graphs. Go to Settings to add graphs.</p>';

        const rows = weeks.map(wk=>{
            const[y,w]=wk.split('-').map(Number);
            const cells=emp.graphs.map(g=>{
                const e=data.find(d=>d.graph_name===g&&d.year===y&&d.week===w);
                let html=e?Number(e.value).toLocaleString():'‚Äî';
                if(e?.breakdown){try{const it=JSON.parse(e.breakdown);if(it.length)html+=`<div style="font-size:0.7rem;color:var(--muted);margin-top:0.2rem;">${it.map(x=>`‚Ä¢ ${x}`).join('<br/>')}</div>`;}catch(err){}}
                return `<td>${html}</td>`;
            }).join('');
            return `<tr><td>W${String(w).padStart(2,'0')} ${y}</td><td style="color:var(--muted)">${getWeekDates(y,w)}</td>${cells}</tr>`;
        }).join('') || `<tr><td colspan="${emp.graphs.length+2}" style="text-align:center;padding:2rem;color:var(--muted)">No data yet</td></tr>`;

        const page=document.createElement('div');
        page.className='page'; page.id='page-'+emp.employee_id;
        page.innerHTML=`
            <div class="page-header"><h2>üë§ ${emp.employee_name}</h2><div class="status-badge"><span class="dot"></span> Live Data</div></div>
            <div class="charts-grid">${chartsHtml}</div>
            <div class="data-table"><div class="table-header">History</div><div style="overflow-x:auto;"><table>
                <thead><tr><th>Week</th><th>Dates</th>${emp.graphs.map(g=>`<th>${g}</th>`).join('')}</tr></thead>
                <tbody>${rows}</tbody>
            </table></div></div>`;
        c.appendChild(page);
        setTimeout(()=>emp.graphs.forEach(g=>{
            const e=data.filter(d=>d.graph_name===g).slice(-12), cid=`ep_${emp.employee_id}_${g.replace(/\W/g,'_')}`;
            mkChart(cid,e.map(d=>`W${String(d.week).padStart(2,'0')} '${String(d.year).slice(2)}`),
                [{data:e.map(d=>d.value),borderColor:col,backgroundColor:col+'22',borderWidth:2.5,tension:0.4,fill:true,pointRadius:4,pointBackgroundColor:col,pointBorderColor:'#1e293b',pointBorderWidth:2}]);
        }),120);
    });
}

// ADD EMPLOYEE
function openModal(){document.getElementById('newEmpName').value='';document.getElementById('modal').classList.add('open');setTimeout(()=>document.getElementById('newEmpName').focus(),100);}
function closeModal(){document.getElementById('modal').classList.remove('open');}
async function addEmployee(){
    const name=document.getElementById('newEmpName').value.trim(); if(!name) return alert('Enter a name.');
    const id='emp_'+Date.now();
    try { await sb('POST','employee_config',{employee_id:id,employee_name:name,graphs:'[]'}); await loadConfig(); renderAll(); closeModal(); toast(`‚úÖ ${name} added!`); } catch(e){ toast('‚ùå Error adding employee',false); console.error(e); }
}

function renderAll(){renderNav();renderOverview();renderComparison();renderLinks();renderSettings();renderEmpPages();}

async function refreshAll(){
    const btn=document.querySelector('.refresh-btn'); btn.textContent='‚è≥ Loading...';
    try{ await loadConfig(); await loadData(); renderAll(); document.getElementById('lastRefresh').textContent=`Updated: ${new Date().toLocaleTimeString()}`; }
    catch(e){ toast('‚ùå Error loading',false); console.error(e); }
    btn.textContent='üîÑ Refresh Data';
}

document.addEventListener('DOMContentLoaded', refreshAll);
</script>
</body>
</html>
